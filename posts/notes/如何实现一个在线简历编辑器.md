---
title: "如何实现一个在线简历编辑器"
date: "2023-03-02"
year: "2023"
abstract: "在线编辑 markdown 文件并导出为 pdf 格式的实现过程"
---

# 如何实现一个在线简历编辑器

## 1. 经过

准备简历期间，发现写一份简历意味着做两件事情：

  1. 写简历内容；
  2. 将内容排版成简历的格式。

写内容的时候我要尽量不去思考如何排版，而写完一份内容后，我需要自由套用不同的样式。网络上有很多满足这种需求的在线简历制作应用，大致流程是，用 markdown 写简历源文件、导入简历应用、编辑预览效果，导出 pdf 文件。用了几个在线简历制作应用后，感觉自己也可以写一个，准备了一下思路：
  - 第一天，理出要解决的问题：
    1. 如何在线编辑文件？思路：读取导入文件，将内容填入 `<textarea>` 应该就能编辑
    2. 如何预览效果？或说如何将字符串的 md 内容转成 html 并插入到页面？思路：markdown 字符串转 html 字符串涉及到两种语言格式的转换，一般的做法是，1）解析 markdown，将之转为 AST（抽象语法树）；2）编译 AST，生成 html 字串，这一整套的事情可交给 `unified` 及其插件完成
    3. 生成的 html 字符串如何显示到网页？思路：可以用 `iframe`，`iframe` 模拟一个独立浏览器环境，将 html 字串交给它即可，如 `<iframe srcdoc="htmlStr">`
    4. 如何实现编辑器中内容改变，iframe 中的页面也跟着改变？思路：使用响应式框架 + 状态管理。
    5. 第一天按照上面的思路用 React & Redux 搭了一个编辑器的雏形，左右两栏，左边编辑 md，右边显示 html，如下所示：

![first-day-work](https://user-images.githubusercontent.com/20923112/222759116-b3f1bc9c-7535-40c4-b042-f9ceef74e852.gif)
  
  - 第二天：用 `CodeMirror` 实现左侧编辑区域，用 `react-markdown` 生成的 React 组件替换右边的 iframe，解决 iframe 整体刷新造成的闪屏问题；
  - 第三天：增加了左右分栏，探索导出 pdf 的方案（有 window.print，jsPdf.html，html2Canvas + jsPdf.addImage 等），采用了 html2Canvas + jsPdf 的方式；
  - 第四天：优化导出 pdf 的分页问题。用 html2Canvas + jsPdf.addImage 的方式导出 pdf 会面临三个坑：1）导出的图片模糊；2）提升图片的清晰度后，文件大小明显上升；3）文件分页后，有的内容会被截断；分页这个坑，目前采用遍历节点树，在跨页的子节点上方插入空白节点，将之挤到下一页的方式暂时解决。

第四天结束后基本实现了导入本地文件，编辑预览，并导出 pdf 的效果，并挂到 netlify 上，如下：

[m2r](m2r.netlify.app)：一个简易的简历页生成器。

[m2r 仓库地址](https://github.com/went2/markdown-to-resume)

后面可能加的功能：
  1. 在线编辑 css
  2. 优化导出 pdf 文件大小问题（意味着不能采用导出图片的方式）

我认为 `html2Canvas` + `jsPdf.addImage` 并不是 web 内容转 pdf 的最优解，想要追求更好 pdf 的效果，可以：1）单独写一个页面，用 window.print 打印网页；2）深入调试 jdfPdf，解决其支持中文字体显示问题。

## 2. 备忘

项目使用的主要第三方库：

1.结构化处理文本的流程： unified.js

[unified.js](https://unifiedjs.com/) 是一套基于语法树处理文本的编程接口，基于它实现的解析器（如 remark，rehype，retext）实现了不同类型文本内容的结构化处理。使用 unified 处理文本的常见过程是：

  - 解析（parse）：由解析器（parser）将文本内容转化为 ST（语法树） ；
  - 转换（run）：由插件接过语法树，进行编辑；
  - 编译（stringify）：由编译器将编辑后的语法树转为文本；

项目中使用的将 markdown 转 React 组件用的是 unified 生态的插件 `react-markdown`

2.[CodeMirror](https://codemirror.net/)，网页用代码编辑器

3.[react-split-pane](https://github.com/tomkp/react-split-pane)：实现左右分栏

4.[html2Canvas](html2canvas.hertzen.com)：将 dom 绘制到 canvas 上生成图片。坑一：图片清晰度低；坑二：文字错位；

5.[jsPdf](https://github.com/parallax/jsPDF)：生成 pdf 文件。坑一：生成的 pdf 不支持中文字体；坑二：与 html2Canvas 结合使用造成的文字截断

提一下文字截断的解决：

使用 html2Canvas 生成图片后，会根据 A4 大小将图片分页，然后分别将每页图片通过 jsPdf.addImage 添加到 pdf 文件，分页时，如果有内容位于分页的界限（很常见的情况），这块内容就会一半在上一页底部，一半在下一页顶部。参考网上的解决经验，我实现了一个“寻找首个最深的跨页子节点”算法，只要传入容器元素，就能以较小的节点遍历找到所有跨页的最深子节点。从而可以在子节点前插入一段有高度的空白元素将子节点分到下一页，避免被截断的命运。具体代码见[项目仓库](https://github.com/went2/markdown-to-resume)