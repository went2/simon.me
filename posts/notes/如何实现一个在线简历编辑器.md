---
title: "如何实现一个在线简历编辑器"
date: "2023-03-02"
year: "2023"
abstract: "在线编辑 markdown 文件并导出为 pdf 格式的实现过程"
---

# 如何实现一个在线简历编辑器

## 1. 背景

准备简历期间，发现写一份简历意味着做两件事情：

  1. 写简历内容；
  2. 将内容排版成简历的格式。

写内容的时候我要尽量不去思考如何排版，而写完一份内容后，我需要自由套用不同的样式。网络上有很多满足这种需求的在线简历制作应用，大致流程是，用 markdown 写简历源文件、导入简历应用、编辑预览效果，导出 pdf 文件。用了几个在线简历制作应用后，想自己实现一个看看水有多深。

## 2. 关键问题

假设要开发一个 markdown 转 pdf 应用如下图，关键问题有哪些？

![m2r-sketch](https://user-images.githubusercontent.com/20923112/222974938-21265d23-2da1-4c76-a120-454d9d403dea.png)

### 2.1 输入

应用的输入来自：本地 markdown 文件或者输入框输入的 markdown 文本。用户选择本地 md 文件后，应用读取文件内容，呈现在编辑器中，可以编辑。

这部分用最简单的方式实现就是 `<input type="file">` + `<textarea>`

### 2.2 处理

应用需要将 md 文本实时转为 html 元素在右边预览区显示，预览区最好能模拟 A4 大小。

这部分需求是将 markdown 文本转为 html 文本，涉及到两种语言间的转换，是一个编译的过程。可以用 `unified` 生态中的插件完成编译操作，得到 html 文本，将它交给 `iframe` 的 `scrdoc` 属性就能完成显示。

此外，应用需要将编辑区的改动实时反映到预览区，可以用 React + Redux 支持该功能，在组件中订阅 Redux 中的状态，就能在状态改变后更新视图。

### 2.3 输出

应用需要支持 pdf 与 md 文件的导出，对于 md 文件，是将应用编辑区的 md 字符串写入文件即可；对于 pdf 导出，需要找解决方案，常见的有：
  1. window.print 打印网页；
  2. jsPdf.html，用 jsPdf 库从网页生成 pdf；
  3. html2Canvas + jsPdf.addImage，先借助 html2Canvas 生成图片，再将图片通过 jsPdf 放到 pdf 文件内

这些是我想到的主要问题，具体开发过程如下：

## 3. 开发过程

  - 第一天，按照上面的思路用 React & Redux 搭了一个编辑器的雏形，左右两栏，左边编辑 md，右边显示 html，如下所示：

![first-day-work](https://user-images.githubusercontent.com/20923112/222759116-b3f1bc9c-7535-40c4-b042-f9ceef74e852.gif)
  
  - 第二天：用 `CodeMirror` 替换左侧编辑区域，用 `react-markdown` 生成 React 组件替换右边的 iframe，解决 iframe 整体刷新造成的闪屏问题；
  - 第三天：增加了左右分栏，试用不同地 pdf 导出方式，决定采用 html2Canvas + jsPdf 方式；
  - 第四天：优化导出 pdf 的分页问题。用 html2Canvas + jsPdf.addImage 的过程中面临三个坑：1）导出的图片模糊；2）提升图片的清晰度后，文件大小明显上升；3）文件分页后，有的内容会被截断；分页这个坑，目前采用遍历节点树，在跨页的子节点上方插入空白节点，将之挤到下一页的方式暂时解决。期间也尝试使用 jsPdf.html 直接从 html 文档生成 pdf，优点是文档体积小，缺点是不支持中文字体，如果要在前端支持中文字体导出，得引入字体文件，设置 `font-family`，字体文件体积太大，有的 node 环境无法打包，这种方式太粗放。

第四天结束后基本实现核心功能：1）导入本地文件，编辑预览，2）导出 pdf，如下：

[m2r](m2r.netlify.app)：一个简易的简历页生成器。

[m2r 仓库地址](https://github.com/went2/markdown-to-resume)

未解决的问题是：1）导出的 pdf 文件大，3 页 pdf 有 2M 左右。这是 html2Canvas 生成图片时将 scale 设为 3 的结果，如果 scale 低于 3，生成的图片会模糊；2）解决文字截断的方式可能会造成新的文字截断，在跨页的子节点上方添加有高度的空白 div，可能会产生新的一页，新的一页很有可能有文字跨页。

这趟实践下来，得到的经验是，`html2Canvas` + `jsPdf.addImage` 并不是 web 内容转 pdf 的最优解，想要追求更清晰的效果和更小的导出文件体积，应该直接将文字写入最终的 pdf，或者单独写一个页面，掉用 window.print 打印网页。

## 4. 第三方库

项目使用的第三方库：

1.结构化处理文本：unified.js

[unified.js](https://unifiedjs.com/) 是一套基于语法树处理文本的编程接口，基于它实现的解析器（如 remark，rehype，retext）支持不同类型文本内容的结构化处理。使用 unified 处理文本的常见过程是：

  - 解析（parse）：由解析器（parser）将文本内容转化为 ST（语法树） ；
  - 转换（run）：由插件接过语法树，进行编辑；
  - 编译（stringify）：由编译器将编辑后的语法树转为文本；

这也是编译器的常见工作流程。项目中使用 `react-markdown` 插件将 markdown 文本转为 React 组件。

2.[CodeMirror](https://codemirror.net/)，网页用代码编辑器

3.[react-split-pane](https://github.com/tomkp/react-split-pane)：实现左右分栏

4.[html2Canvas](html2canvas.hertzen.com)：将 dom 绘制到 canvas 上生成图片。坑一：图片清晰度低（需要使用更高的 scale 值，如 3）；坑二：文字会错位（要使用 `1.0.0-alpha.12` 版本）；

5.[jsPdf](https://github.com/parallax/jsPDF)：生成 pdf 文件。坑一：生成的 pdf 不支持中文字体；坑二：与 html2Canvas 结合使用会造成的文字截断。

记一下文字截断的解决：

使用 html2Canvas 生成图片后，要根据 A4 大小将图片分页，然后分别将每页图片通过 jsPdf.addImage 添加到 pdf 文件，分页时，如果有内容位于分页的界限（常见情况），这块内容就会一半在上一页底部，一半在下一页顶部。参考网上的解决经验，我实现了一个“寻找首个最深的跨页子节点”算法，只要传入容器元素，就能以较小的节点遍历操作找到所有跨页的最深子节点。从而可以在子节点前插入一段有高度的空白元素将子节点分到下一页，避免被截断的命运。具体代码见[项目仓库](https://github.com/went2/markdown-to-resume)